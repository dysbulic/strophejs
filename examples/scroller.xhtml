<!DOCTYPE html PUBLIC
  "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Scroller Interface</title>
  <script type="application/javascript" src=".../lib/jquery/jquery.js"/>
  <script type="application/javascript" src=".../lib/strophe/strophe.js"/>
  <script type="application/javascript" src=".../lib/tip/Array.each.js"/>
  <script type="application/javascript" src=".../lib/tip/pointers.js"/>
  <script type="application/javascript" src=".../lib/tip/List.js"/>

  <script type="application/javascript" src="scroller.jquery"/>
  <script type="application/javascript"><![CDATA[
      ( function() {
          var root = document.documentElement

          var state = {
              scroller : undefined,
              top : root.scrollTop,
              left : root.scrollLeft,
              width : root.scrollWidth,
              height : root.scrollHeight,
          }

          // Linear translation between two tixels
          var position = {
              linear : function ( start, end ) {
                  var current = { time : ( new Date() ).getTime() }
                  var offset =
                      Math.min(
                          1,
                          ( ( current.time - start.time )
                            / ( end.time - start.time ) )
                      )
                  return {
                      offset: offset,
                      x : offset * ( end.x - start.x ),
                      y : offset * ( end.y - start.y ),
                      done : offset === 1, 
                  }
              },
          }
          
          function snapshot( ) {
              var moveTo = position( this.start, this.end )
              console.log( moveTo.done )
              window.scroll( moveTo.x - this.win.width / 2,
                             moveTo.y - this.win.height / 2 )
              if( moveTo.done ) {
                  state.scroller = undefined
              }
          }
          
          function Scene( watcher ) { // saccade
              var self = this
              var args = Array.prototype.slice.call( arguments )
              
              var interval = {
                  id: undefined,
                  length: 1 /* seconds */ * 1000,
              }
              
              this.__defineGetter__( 'go', function() {
                  if( interval.id === undefined ) {
                      interval.id =
                          setInterval( function() {
                              watcher.apply( state, args )
                          },
                                       interval.length
                                     )
                  }
                  return this
              } )
              this.__defineGetter__( 'stop', function() {
                  if( interval.id !== undefined ) {
                      clearInterval( interval.id )
                      interval.id = undefined
                  }
                  return this
              } )
          }
      
          function watcher( ) {
              var scroll = { interval : 30 /* seconds */ * 1000, }
              var current = new List( {
                  top : root.scrollTop,
                  left : root.scrollLeft,
                  width : root.scrollWidth,
                  height : root.scrollHeight,
              } )
          
              var change = false
              try {
                  var self = this
                  current.each( function( attr, name ) {
                      console.log( name + ':' + attr + ':' +  current[name] )
                      if( self[name] !== attr ) {
                          throw true
                      }
                  } )
              } catch( val ) {
                  change = val
              }

              if( change ) {
                  console.log( 'change' )
                  var win = {
                      width : root.clientWidth,
                      height : root.clientHeight,
                  }
                  if( this.move === undefined ) {
                      this.move = new Snapshot( {
                          win : win,
                          start : {
                              x : ( current.left
                                    + win.width / 2 ),
                              y : ( current.top
                                    + win.height / 2 ),
                              width : win.width,
                              height : win.height,
                              time : ( new Date() ).getTime(),
                          }
                      } )
                  }
                  this.move.end = $.merge( {
                      time : ( state.scroller.start.time
                               + scroll.interval )
                    },
                    ( {
                        get top() { return {
                            get left() { return {
                                x : win.width / 2,
                                y : win.height / 2,
                            } },
                            get right() { return {
                                x : current.width - win.width / 2,
                                y : win.height / 2,
                            } },
                        } },
                        get bottom() { return {
                            get left() { return {
                                x : win.width / 2,
                                y : current.height - win.height / 2,
                            } },
                            get right() { return {
                                x : current.width - win.width / 2,
                                y : current.height - win.height / 2,
                            } },
                        } }
                    } ).bottom.left
                  )
              }
              snapshot.apply( this, arguments )
          }
           
          $( function() {
              var scene = new Scene( watcher )
              scene.go
              $('body').append( $('<p/>').css( { 'margin-top' : '2000px' } ).text( 'test' ) )
          } )
      } )()
  ]]></script>
  <style type="text/css">
    html, body { margin: 0; min-height: 200px }
    form { float: left }
    label:after { content: ":" }
    label { display: inline-block; min-width: 5.5em; text-align: right }
    li:last-child button { float: right }
    li { list-style: none; padding: .1em 0 }
    body > ol { margin: 0; padding: 0 }
    body > ol > li:before, body > ol > li:after {
      content: ''; clear: both; display: block
    }
    body > ol > li { border-style: double none; padding: 1em;
                     border-width: 3px; margin-top: -3px }
    body > ol > li:first-child { margin-top: 3px; border-color: blue }
  </style>
</head>
<body>
  <ol id="log"/>
  <ol id="action">
    <li>
      <form id="connect" action="">
        <fieldset>
          <legend>XMPP Connect?</legend>
          <ul>
            <li>
              <label for="user"><acronym title="identifier">ID</acronym></label>
              <input id="user" type="text" value="mimis.test@gmail.com" />
            </li>
            <li>
              <label for="server">Server</label>
              <input id="server" type="text" value="talk.google.com" />
            </li>
            <li>
              <label for="pass">Password</label>
              <input id="pass" type="password" value="mimistest" />
            </li>
          </ul>
        </fieldset>
      </form>
    </li>
  </ol>
</body>
</html>
